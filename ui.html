<!DOCTYPE html>
<html>
  <head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
      window.onload = function () {
        if (!window.JSZip) {
          console.error("JSZip failed to load");
          document.getElementById("download-all-web").disabled = true;
          document.getElementById("download-all-web").title =
            "Download all feature unavailable";
        } else {
          console.log("JSZip loaded successfully");
        }
      };
    </script>
    <style>
      body {
        font-family: Inter, -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, sans-serif;
        margin: 0;
        padding: 20px;
      }
      input {
        width: 100%;
        padding: 8px;
        margin-bottom: 12px;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        box-sizing: border-box;
      }
      input:focus {
        border: 1px solid transparent;
        outline: 1px solid #ff0266;
      }
      button {
        background: #ff0266;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        width: 100%;
        margin-bottom: 8px;
      }
      button:disabled {
        background: #d1d5db;
        color: #1f2937;
        cursor: not-allowed;
      }
      button.secondary {
        background: #f9fafb;
        color: #ff0266;
        border: 1px solid #ff0266;
      }
      .error,
      .success {
        font-size: 12px;
      }
      .error {
        color: #db2b3a;
        margin-top: 8px;
      }
      .success {
        color: #659f93;
        margin-top: 8px;
      }
      #download-section {
        display: none;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #eee;
      }
    </style>
  </head>
  <body>
    <div id="form-section">
      <input
        type="text"
        id="whiteLabelName"
        placeholder="Enter white label name (e.g., ChainelsWhiteLabel)"
        value="ChainelsWhiteLabel"
      />
      <button id="generate">Generate Theme Files</button>
    </div>

    <div id="download-section">
      <h3>Generated Files</h3>
      <button id="download-all-web" class="secondary">
        Download All Web Files
      </button>
      <div style="margin: 16px 0; border-top: 1px solid #eee"></div>
      <button id="download-ts" class="secondary">Download TypeScript</button>
      <button id="download-scss-colors" class="secondary">
        Download Colors SCSS
      </button>
      <button id="download-scss-theme" class="secondary">
        Download Theme SCSS
      </button>
      <button id="download-scss-email" class="secondary">
        Download Email SCSS
      </button>
      <div style="margin: 16px 0; border-top: 1px solid #eee"></div>
      <div id="pr-form">
        <h3>Create Pull Requests</h3>
        <input
          type="text"
          id="bitbucket-username"
          placeholder="Bitbucket Username"
          value="guidochainels"
          required
        />
        <input
          type="password"
          id="bitbucket-token"
          placeholder="Bitbucket App Password"
          required
        />
        <div style="font-size: 12px; margin-bottom: 12px; color: #666">
          Create an app password with these permissions:
          <ul style="margin: 8px 0; padding-left: 20px">
            <li>Repository: Read, Write</li>
            <li>Pull requests: Read, Write</li>
          </ul>
          <a
            href="https://bitbucket.org/account/settings/app-passwords/"
            target="_blank"
            >Create App Password</a
          >
        </div>
        <button id="submit-prs" class="secondary">Create Pull Requests</button>
      </div>
    </div>

    <div id="message"></div>

    <script>
      let generatedFiles = null;

      document.getElementById("generate").onclick = () => {
        const whiteLabelName = document
          .getElementById("whiteLabelName")
          .value.trim();

        if (!whiteLabelName) {
          showMessage("Please enter a white label name", "error");
          return;
        }

        // Reset UI state
        document.getElementById("download-section").style.display = "none";
        document.getElementById("generate").disabled = true;

        parent.postMessage(
          {
            pluginMessage: {
              type: "generate-theme",
              whiteLabelName,
            },
          },
          "*"
        );
      };

      document.getElementById("download-ts").onclick = () => {
        if (!generatedFiles?.typescript) return;
        downloadFile(
          `${document.getElementById("whiteLabelName").value}.brand.ts`,
          generatedFiles.typescript
        );
      };

      document.getElementById("download-scss-colors").onclick = () => {
        if (!generatedFiles?.scss) return;
        downloadFile(
          `${document.getElementById("whiteLabelName").value}.colors.scss`,
          generatedFiles.scss
        );
      };

      document.getElementById("download-scss-theme").onclick = () => {
        if (!generatedFiles?.scssTheme) return;
        downloadFile(
          `${document.getElementById("whiteLabelName").value}.theme.scss`,
          generatedFiles.scssTheme
        );
      };

      document.getElementById("download-scss-email").onclick = () => {
        if (!generatedFiles?.scssTheme) return;
        downloadFile(
          `${document.getElementById("whiteLabelName").value}-email.scss`,
          generatedFiles.scssTheme
        );
      };

      document.getElementById("download-all-web").onclick = async () => {
        try {
          if (
            !generatedFiles?.typescript ||
            !generatedFiles?.scss ||
            !generatedFiles?.scssTheme
          ) {
            showMessage("Error: Missing generated files", "error");
            return;
          }

          const whiteLabelName =
            document.getElementById("whiteLabelName").value;

          // Create a new ZIP using the browser's JSZip
          const zip = new JSZip();

          // Add files to the zip with correct names
          zip.file(`${whiteLabelName}.brand.ts`, generatedFiles.typescript);
          zip.file(`${whiteLabelName}.colors.scss`, generatedFiles.scss);
          zip.file(`${whiteLabelName}.theme.scss`, generatedFiles.scssTheme);
          zip.file(`${whiteLabelName}-email.scss`, generatedFiles.scssTheme);

          // Generate and download the zip
          const blob = await zip.generateAsync({ type: "blob" });
          const url = URL.createObjectURL(blob);

          const link = document.createElement("a");
          link.href = url;
          link.download = `${whiteLabelName}-web-files.zip`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);

          showMessage("Files downloaded successfully!", "success");
        } catch (error) {
          console.error("Error creating zip:", error);
          showMessage("Error creating zip file", "error");
        }
      };

      document.getElementById("submit-prs").onclick = () => {
        const submitButton = document.getElementById("submit-prs");
        const username = document.getElementById("bitbucket-username").value;
        const token = document.getElementById("bitbucket-token").value;

        if (!username || !token) {
          showMessage("Please enter both username and app password", "error");
          return;
        }

        if (
          !generatedFiles?.typescript ||
          !generatedFiles?.scss ||
          !generatedFiles?.scssTheme
        ) {
          showMessage("Error: Missing generated files", "error");
          return;
        }

        // Disable button and show loading state
        submitButton.disabled = true;
        submitButton.textContent = "Creating Pull Request...";

        const whiteLabelName = document.getElementById("whiteLabelName").value;

        parent.postMessage(
          {
            pluginMessage: {
              type: "create-prs",
              whiteLabelName,
              credentials: { username, token },
              files: {
                typescript: generatedFiles.typescript,
                scss: generatedFiles.scss,
                scssTheme: generatedFiles.scssTheme,
              },
            },
          },
          "*"
        );
      };

      function downloadFile(filename, content) {
        const element = document.createElement("a");
        element.setAttribute(
          "href",
          "data:text/plain;charset=utf-8," + encodeURIComponent(content)
        );
        element.setAttribute("download", filename);
        element.style.display = "none";
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);
      }

      function showMessage(message, type) {
        const messageEl = document.getElementById("message");
        messageEl.textContent = message;
        messageEl.className = type;
      }

      onmessage = (event) => {
        const msg = event.data.pluginMessage;
        const submitButton = document.getElementById("submit-prs");

        // Reset submit button state
        submitButton.disabled = false;
        submitButton.textContent = "Create Pull Requests";

        if (msg.type === "error") {
          showMessage(msg.message, "error");
          return;
        }

        if (msg.type === "prs-created") {
          showMessage(msg.message, "success");
        }

        if (msg.type === "theme-generated") {
          generatedFiles = msg.data;
          document.getElementById("download-section").style.display = "block";
        }
      };
    </script>
  </body>
</html>
